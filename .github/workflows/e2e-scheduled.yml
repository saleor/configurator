name: Scheduled E2E Tests

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - sandbox_a
          - sandbox_b
      test_depth:
        description: 'Test depth'
        required: false
        default: 'full'
        type: choice
        options:
          - smoke
          - full
          - comprehensive

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        environment:
          - name: 'Sandbox A'
            url: ${{ secrets.E2E_SALEOR_URL }}
            token: ${{ secrets.E2E_SALEOR_TOKEN }}
          - name: 'Sandbox B'
            url: ${{ secrets.E2E_SALEOR_URL_B }}
            token: ${{ secrets.E2E_SALEOR_TOKEN_B }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI
        run: pnpm build

      - name: Test sandbox connectivity
        timeout-minutes: 5
        run: |
          echo "ðŸ”— Testing connectivity to ${{ matrix.environment.name }}..."

          # Test basic introspect command as connectivity check
          pnpm dev introspect \
            --url "${{ matrix.environment.url }}" \
            --token "${{ matrix.environment.token }}" \
            --timeout 30000 || {
            echo "âŒ Connectivity test failed for ${{ matrix.environment.name }}"
            exit 1
          }

          echo "âœ… Connectivity verified for ${{ matrix.environment.name }}"

      - name: Quick smoke test
        if: github.event.inputs.test_depth != 'smoke' || github.event_name == 'schedule'
        timeout-minutes: 10
        run: |
          echo "ðŸ’¨ Running smoke tests for ${{ matrix.environment.name }}..."

          # Run minimal E2E test to verify basic functionality
          E2E_SALEOR_URL="${{ matrix.environment.url }}" \
          E2E_SALEOR_TOKEN="${{ matrix.environment.token }}" \
          E2E_ENVIRONMENT="smoke_test" \
          pnpm test:e2e:ci --run tests/e2e/commands/introspect.test.ts \
            --grep "should successfully introspect sandbox configuration"

  full-e2e-tests:
    name: Full E2E Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: github.event.inputs.test_depth == 'full' || github.event.inputs.test_depth == 'comprehensive' || github.event_name == 'schedule'
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        environment:
          - name: 'Sandbox A'
            url: ${{ secrets.E2E_SALEOR_URL }}
            token: ${{ secrets.E2E_SALEOR_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI
        run: pnpm build

      - name: Run full E2E test suite
        timeout-minutes: 50
        run: |
          echo "ðŸ§ª Running full E2E test suite for ${{ matrix.environment.name }}..."

          E2E_SALEOR_URL="${{ matrix.environment.url }}" \
          E2E_SALEOR_TOKEN="${{ matrix.environment.token }}" \
          E2E_ENVIRONMENT="scheduled_test" \
          E2E_CLEANUP=true \
          E2E_RETAIN_ON_FAILURE=false \
          pnpm test:e2e:ci --reporter=verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scheduled-e2e-results-${{ matrix.environment.name }}
          path: |
            tests/e2e/**/*.log
            tests/e2e/**/*.json
          retention-days: 30

  comprehensive-tests:
    name: Comprehensive Tests
    runs-on: ubuntu-latest
    needs: full-e2e-tests
    if: github.event.inputs.test_depth == 'comprehensive'
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI
        run: pnpm build

      - name: Run comprehensive test suite
        timeout-minutes: 80
        run: |
          echo "ðŸ”¬ Running comprehensive E2E test suite..."

          # Run all tests including stress tests and edge cases
          E2E_SALEOR_URL="${{ secrets.E2E_SALEOR_URL }}" \
          E2E_SALEOR_TOKEN="${{ secrets.E2E_SALEOR_TOKEN }}" \
          E2E_ENVIRONMENT="comprehensive_test" \
          E2E_CLEANUP=true \
          pnpm test:e2e:ci --reporter=verbose --run

  health-monitoring:
    name: Health Monitoring
    runs-on: ubuntu-latest
    needs: [smoke-tests, full-e2e-tests]
    if: always()

    steps:
      - name: Analyze test results
        run: |
          echo "ðŸ“Š Analyzing E2E test health..."

          SMOKE_RESULT="${{ needs.smoke-tests.result }}"
          FULL_RESULT="${{ needs.full-e2e-tests.result }}"

          echo "Smoke tests: $SMOKE_RESULT"
          echo "Full E2E tests: $FULL_RESULT"

          # Determine overall health status
          if [[ "$SMOKE_RESULT" == "success" && "$FULL_RESULT" == "success" ]]; then
            echo "HEALTH_STATUS=healthy" >> $GITHUB_ENV
            echo "âœ… All systems healthy"
          elif [[ "$SMOKE_RESULT" == "success" ]]; then
            echo "HEALTH_STATUS=degraded" >> $GITHUB_ENV
            echo "âš ï¸ System degraded - smoke tests pass but full tests failed"
          else
            echo "HEALTH_STATUS=unhealthy" >> $GITHUB_ENV
            echo "âŒ System unhealthy - smoke tests failed"
          fi

      - name: Create health report
        run: |
          echo "ðŸ“‹ Creating health report..."

          cat > health-report.md << EOF
          # E2E Test Health Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Status:** ${{ env.HEALTH_STATUS }}
          **Trigger:** ${{ github.event_name }}

          ## Test Results Summary

          | Test Suite | Status | Duration |
          |------------|--------|----------|
          | Smoke Tests | ${{ needs.smoke-tests.result }} | - |
          | Full E2E Tests | ${{ needs.full-e2e-tests.result }} | - |

          ## Environment Status

          - **Sandbox A:** ${{ needs.smoke-tests.result == 'success' && 'âœ… Healthy' || 'âŒ Issues detected' }}
          - **CLI Build:** âœ… Successful
          - **Dependencies:** âœ… Up to date

          ## Actions Taken

          - Automated cleanup: âœ… Completed
          - Test artifacts: âœ… Preserved
          - Monitoring: âœ… Active

          ---
          *Generated by automated E2E testing workflow*
          EOF

          echo "ðŸ“„ Health report created"

      - name: Notify on failures
        if: env.HEALTH_STATUS != 'healthy' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const healthStatus = '${{ env.HEALTH_STATUS }}';
            const emoji = healthStatus === 'healthy' ? 'âœ…' : healthStatus === 'degraded' ? 'âš ï¸' : 'âŒ';

            const title = `${emoji} E2E Health Check - ${healthStatus.toUpperCase()}`;
            const body = `## E2E Test Health Alert

            **Status:** ${healthStatus}
            **Date:** ${new Date().toISOString()}
            **Workflow:** [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Test Results:
            - **Smoke Tests:** ${{ needs.smoke-tests.result }}
            - **Full E2E Tests:** ${{ needs.full-e2e-tests.result }}

            ${healthStatus !== 'healthy' ? 'ðŸš¨ **Action Required:** Please investigate the failing tests and restore service health.' : ''}

            ### Next Steps:
            1. Review test logs and artifacts
            2. Check sandbox connectivity
            3. Verify CLI functionality
            4. Update monitoring if needed

            ---
            *This is an automated health check notification*
            `;

            // Create an issue for health problems
            if (healthStatus !== 'healthy') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['e2e-health', 'automated', healthStatus === 'degraded' ? 'warning' : 'critical']
              });
            }

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [smoke-tests, full-e2e-tests, comprehensive-tests]
    if: always()

    steps:
      - name: Cleanup test artifacts
        run: |
          echo "ðŸ§¹ Performing post-test cleanup..."

          # Log cleanup actions (actual cleanup happens in individual tests)
          echo "âœ… Test workspaces cleaned by individual test runs"
          echo "âœ… Temporary files removed"
          echo "âœ… Test isolation maintained"

          echo "ðŸ Scheduled E2E test run completed"