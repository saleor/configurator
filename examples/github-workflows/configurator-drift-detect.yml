# Saleor Configurator - Drift Detection
#
# This workflow runs on a schedule to detect configuration drift
# between your repository and the live Saleor instance.
#
# When drift is detected, it creates a GitHub issue for visibility.
#
# Setup:
# 1. Add SALEOR_URL and SALEOR_TOKEN to repository secrets
# 2. Copy this file to .github/workflows/configurator-drift-detect.yml
# 3. Adjust the cron schedule as needed

name: Configuration Drift Detection

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
          - all

jobs:
  detect-drift-staging:
    name: Check Staging Drift
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.environment == 'staging' ||
      github.event.inputs.environment == 'all'

    outputs:
      has-drift: ${{ steps.diff.outputs.has-changes }}
      drift-summary: ${{ steps.diff.outputs.summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Drift
        uses: saleor/configurator/action@v1
        id: diff
        continue-on-error: true
        with:
          command: diff
          saleor-url: ${{ secrets.STAGING_SALEOR_URL }}
          saleor-token: ${{ secrets.STAGING_SALEOR_TOKEN }}
          config-path: config.yml
          json-output: true

      - name: Report Drift
        if: steps.diff.outputs.has-changes == 'true'
        run: |
          echo "## Staging Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Changes | ${{ steps.diff.outputs.changes-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Creates | ${{ steps.diff.outputs.creates-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Updates | ${{ steps.diff.outputs.updates-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deletes | ${{ steps.diff.outputs.deletes-count }} |" >> $GITHUB_STEP_SUMMARY

  detect-drift-production:
    name: Check Production Drift
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.environment == 'production' ||
      github.event.inputs.environment == 'all'

    outputs:
      has-drift: ${{ steps.diff.outputs.has-changes }}
      drift-summary: ${{ steps.diff.outputs.summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Drift
        uses: saleor/configurator/action@v1
        id: diff
        continue-on-error: true
        with:
          command: diff
          saleor-url: ${{ secrets.PROD_SALEOR_URL }}
          saleor-token: ${{ secrets.PROD_SALEOR_TOKEN }}
          config-path: config.yml
          json-output: true

      - name: Report Drift
        if: steps.diff.outputs.has-changes == 'true'
        run: |
          echo "## Production Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Changes | ${{ steps.diff.outputs.changes-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Creates | ${{ steps.diff.outputs.creates-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Updates | ${{ steps.diff.outputs.updates-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deletes | ${{ steps.diff.outputs.deletes-count }} |" >> $GITHUB_STEP_SUMMARY

  # Create issue if drift detected
  create-drift-issue:
    name: Create Drift Issue
    runs-on: ubuntu-latest
    needs: [detect-drift-staging, detect-drift-production]
    if: |
      always() &&
      (needs.detect-drift-staging.outputs.has-drift == 'true' ||
       needs.detect-drift-production.outputs.has-drift == 'true')

    permissions:
      issues: write

    steps:
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const stagingDrift = '${{ needs.detect-drift-staging.outputs.has-drift }}' === 'true';
            const productionDrift = '${{ needs.detect-drift-production.outputs.has-drift }}' === 'true';

            const environments = [];
            if (stagingDrift) environments.push('staging');
            if (productionDrift) environments.push('production');

            const title = `Configuration Drift Detected: ${environments.join(', ')}`;

            const body = `## Configuration Drift Alert

            Configuration drift has been detected in the following environment(s):

            ${stagingDrift ? '- **Staging**: Configuration has drifted from repository state' : ''}
            ${productionDrift ? '- **Production**: Configuration has drifted from repository state' : ''}

            ### Recommended Actions

            1. Review the workflow run for details: [View Run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            2. Investigate the source of drift (manual changes, failed deployments, etc.)
            3. Either:
               - Update the config file to match the current state (if changes are intentional)
               - Run a deployment to restore the expected state

            ### Auto-Generated

            This issue was automatically created by the drift detection workflow.
            Run: ${process.env.GITHUB_RUN_ID}
            `;

            // Check for existing open drift issues
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift,configuration'
            });

            if (existingIssues.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues[0].number,
                body: `## New Drift Detection Run\n\n${new Date().toISOString()}\n\nEnvironments affected: ${environments.join(', ')}\n\n[View workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`
              });
              console.log(`Updated existing issue #${existingIssues[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['drift', 'configuration']
              });
              console.log('Created new drift issue');
            }
