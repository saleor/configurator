# Configurator

> [!WARNING]
> This project is in early development. Please use with caution.

Configurator is a "commerce as code" tool that helps you automate the creation and management of data models in Saleor. Instead of manually creating product types, attributes, products, and variants, you can define them in a configuration file and let the tool handle the synchronization with your Saleor instance.

## Quickstart

1. Create an app token with all permissions.
2. Pull your current configuration from Saleor to `config.yml`:

```bash
pnpm pull --url="https://your-store.saleor.cloud/graphql/" --token="your-app-token""
```

3. Edit the configuration file to your needs. You can find the schema documentation in [SCHEMA.md](SCHEMA.md).
4. Push the changes to Saleor:

```bash
pnpm push --url="https://your-store.saleor.cloud/graphql/" --token="your-app-token"
```

The above will apply the changes to your Saleor instance.

## Configuration

```yaml
// Example config.yml
shop:
  customerAllowedToSetExternalReference: false
  defaultMailSenderName: "Saleor Store"
  defaultMailSenderAddress: "store@example.com"
  displayGrossPrices: true
  enableAccountConfirmationByEmail: true
  limitQuantityPerCheckout: 50
  trackInventoryByDefault: true
  reserveStockDurationAnonymousUser: 60
  reserveStockDurationAuthenticatedUser: 120
  defaultDigitalMaxDownloads: 5
  defaultDigitalUrlValidDays: 30
  defaultWeightUnit: KG
  allowLoginWithoutConfirmation: false

channels:
  - name: Poland
    currencyCode: PLN
    defaultCountry: PL
    slug: poland
    isActive: false  # Channels are inactive by default
    settings:
      allocationStrategy: PRIORITIZE_SORTING_ORDER
      automaticallyConfirmAllNewOrders: true
      automaticallyFulfillNonShippableGiftCard: true
      expireOrdersAfter: 30
      deleteExpiredOrdersAfter: 60
      markAsPaidStrategy: TRANSACTION_FLOW
      allowUnpaidOrders: false
      includeDraftOrderInVoucherUsage: true
      useLegacyErrorFlow: false
      automaticallyCompleteFullyPaidCheckouts: true
      defaultTransactionFlowStrategy: AUTHORIZATION

productTypes:
  - name: Book
    attributes:
      - name: Author
        inputType: PLAIN_TEXT
      - name: Genre
        inputType: DROPDOWN
        values:
          - name: Fiction
          - name: Non-Fiction
          - name: Fantasy
      - name: Related Books
        inputType: REFERENCE
        entityType: PRODUCT


pageTypes:
  - name: Blog Post
    attributes:
      - name: Title
        inputType: PLAIN_TEXT
      - name: Description
        inputType: PLAIN_TEXT
      - name: Published Date
        inputType: DATE
      - name: Related Posts
        inputType: REFERENCE
        entityType: PAGE

categories:
  - name: "Fiction"
    subcategories:
      - name: "Fantasy"
  - name: "Non-Fiction"
    subcategories:
      - name: "Science"
      - name: "History"

products:
  - name: "Sample Fiction Book"
    productType: "Book"
    category: "Fiction"
    description: "A reference book product for testing the Book product type"
    attributes:
      Author: "Jane Doe"
      Genre: "Fiction"
    variants:
      - name: "Hardcover"
        sku: "BOOK-001-HC"
        weight: 1.2
        attributes:
          Size: "Large"
          Cover: "Hardcover"
        # Note: Channel listings will be supported in a future release
        channelListings: []
      - name: "Paperback"
        sku: "BOOK-001-PB"
        weight: 0.8
        attributes:
          Size: "Standard"
          Cover: "Paperback"
        channelListings: []
  
  - name: "Sample Non-Fiction Book"
    productType: "Book"
    category: "Non-Fiction/Science"
    description: "Demonstrates subcategory assignment and reference attributes"
    attributes:
      Author: "Dr. John Smith"
      Genre: "Non-Fiction"
      Related Books: ["Sample Fiction Book"]  # Reference to other products
    variants:
      - name: "Digital"
        sku: "BOOK-002-DIG"
        digital: true
        attributes:
          Format: "PDF"
          DRM: "None"
        channelListings: []
      - name: "Print"
        sku: "BOOK-002-PRT"
        weight: 0.9
        attributes:
          Size: "Standard"
          Cover: "Paperback"
        channelListings: []
```

> [!TIP]
> See [SCHEMA.md](SCHEMA.md) for schema documentation with all the available properties.

## Development

### Installing dependencies

```bash
pnpm install
```

This will install the dependencies and fetch the Saleor schema needed for [gql.tada](https://gql-tada.0no.co/) to generate the types.

### Schema Documentation

The configuration schema is automatically documented from Zod schemas with GraphQL field mappings. The `SCHEMA.md` file is automatically regenerated by CI when schema files change.

**Manual generation** (if needed):

```bash
pnpm run generate-docs
```

The documentation includes:

- GraphQL field mappings for each configuration option
- Field types and required/optional status
- Enum values and examples
- Proper markdown structure with table of contents

### Versioning

This project uses [Changesets](https://github.com/changesets/changesets) for version management and changelog generation.

Please execute the following command when making changes that should be released:

```bash
# Document your changes
pnpm changeset
```

**Automated workflow:**

1. PRs require changesets (enforced by CI)
2. When PRs with changesets are merged, a Release PR is automatically created
3. Merging the Release PR finalizes the version and creates a GitHub release

**Skip changesets:** Add the `skip-changeset` label to PRs that don't need versioning (docs, tests, internal changes).

## Commands

### `pnpm push`

Reads the configuration file from a given path and creates/updates the data models in Saleor.

#### Options

- `--url` (required): The URL of the Saleor instance
- `--token` (required): App token with necessary permissions
- `--config` (optional): Path to configuration file (defaults to `config.yml`)

#### Usage

```bash
# Basic usage
pnpm push --url="https://your-store.saleor.cloud/graphql/" --token="your-app-token"

# With custom config file
pnpm push --url="https://your-store.saleor.cloud/graphql/" --token="your-app-token" --config="production.yml"
```

Currently, it supports:

- [x] Shop settings configuration
- [x] Channels with settings (payment, stock, order, checkout)
- [x] Attributes and product types
- [x] Page types with attributes
- [x] Categories and subcategories
- [x] Products with variants, SKUs, and attributes
- [ ] Product variants with channel pricing and inventory
- [ ] Warehouses and shipping zones
- [ ] Collections and discounts

### `pnpm pull`

Retrieves the configuration from the Saleor instance and saves it to a file under the given path.

#### Options

- `--url` (required): The URL of the Saleor instance
- `--token` (required): App token with necessary permissions
- `--config` (optional): Path to configuration file (defaults to `config.yml`)

#### Usage

```bash
# Basic usage
pnpm pull --url="https://your-store.saleor.cloud/graphql/" --token="your-app-token"

# With custom config file
pnpm pull --url="https://your-store.saleor.cloud/graphql/" --token="your-app-token" --config="backup.yml"
```

Currently, it supports:

- [x] Fetching channels
- [x] Saving config to config.yml file
- [x] Fetching product types
- [x] Fetching page types
- [x] Fetching attributes

### Limitations

- Configurator fetches first 100 items from all paginated queries.
